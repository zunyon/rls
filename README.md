# rls

rls is a file listing command-line tool with a different design philosophy from ls.<br>
It displays the unique parts of directory and file names in color to enhance fish shell filename completion.

---

`rls`はファイルやディレクトリ名の `ユニークな部分文字列に色付け` した一覧を表示するプログラムです。<br>
`rls`の実行結果と，`fish` のファイル名補完機能を併用すると，キーボード入力を減らすことができます。

例えば，あるディレクトリの `rls` の実行結果から，`emacs` で `countfunction.c` を編集することを想定します。<br>
`fish` のコマンドラインで `emacs` の後に `n.c` と入力して`TAB` を押すと，`countfunction.c` と補完されます。

![rls_ファイル名補完](demo_rls.gif)<br>
他のファイルも，色付けされている部分を入力すればそのファイルが補完対象になります。<br>
`rls.fish` の場合は，`.f` だけ入力すれば補完対象です。
<br><br>


## 開発環境・動作環境
`rls` のコンパイルに `make` を使用します。コンパイルに必要なファイルは `rls.c` のみです。<br>
下記は `make` と `rls` の動作を確認した開発環境です。<br>
gcc のバージョンによって，必要であれば `{` の位置などを適当に修正してください。

|     |Ubuntu|     wsl|  Other|
  ---:|  ---:|    ---:|   ---:
 uname|6.15.0|6.6.87.2|6.12.25
   gcc|14.3.0|  11.4.0| 10.2.1
  make| 4.4.1|     4.3|    4.3
  fish| 4.0.2|   3.3.1|  3.1.2

### `rls.c` 以外のファイルについて
rls.fish, countfunction.c, countfunction.h などが含まれています。

- countfuncion.c, countfunction.h
  - 標準的な関数への wrapper 関数を記載<br>
    warapper 関数はほぼ count しているだけなので，profile 時や，アルゴリズムの実装を試すときなどの指標になります。<br>
    また，opendir/readdir/closedir による scandir() の代替実装があるので，他の OS や開発環境などで参考になるかもしれません。<br>
    `make debug` や `make count` などで使用されます。
- rls.fish
  - fish 用の .fish ファイル<br>
    ~/.config/fish/completions/ に格納します。主要なオプションが記載されています。

### 補完例の terminal 環境
上記の terminal 環境は下記です。
- `Windows Terminal` の配色を `Tango Dark` で使用
- 環境変数 `RLS_COLORS` に `base=37:normal=34:dir=36:fifo=33:socket=35:device=33:error=31:paint=32:normal=1:dir=1:socket=1:device=1:label=1:error=1:paint=1:reset=0` をセット
<br>

色の設定はデフォルトカラーと同じで，後半の `normal=1` 以降に強調（明るい色）を設定しています。<br>
`rls` の色指定の実装は，256 色（5 で決め打ち，true color (2) の実装はしていない）です。（`initColor()` 参照）<br>
その中でも SGR（select Graphic Rendition）部分を指定しているので `Solarized Dark` 等の配色を使用すると，`Tango Dark` と異なる表示色になります。
<br><br>


## 設計思想・作成背景
ファイル一覧を表示するプログラムは多数存在しており，それらのプログラムはファイル自体の情報を扱います。<br>
ファイル名の補完を考えると，ファイル自体の情報だけでは足りません。<br>
`rls` は，ファイル自体の情報に加えて，ディレクトリ内の他のファイル名との "差分" 情報を計算します。<br>
"差分" 情報は，ファイルの増減・ファイル名の変更などによって変化する "可変" 情報であり，ファイル名の補完に有用な情報です。<br>
この "差分" 情報を視覚化しているプログラムを見なかったため，`rls` では色付けして表示しています。<br>
`rls` では，この "差分" 情報をユニーク文字列と呼んでいます。
<br>

### 固定情報と色の価値について
一般的に，ファイル情報に色を付けて表示するプログラムは多数存在していますが，主に "固定"情報 を示すために "色" が用いられています。固定情報を色で表す目的は "区別" や "注視" であることが多く，情報を "区別" するために "属性自体" に "色" を付けて表示したり，情報に "注視" させるために "場所 (位置)" に "色" が付けられています。<br>
例えば，ファイルの属性 (mode や拡張子) による色分けや，決まった出力フォーマットとその色分けです。<br>
多くのファイル情報は，それ自体が変化しない "固定"情報 のため，ユーザーの慣れ (利用回数や利用時間により覚えていく) と共に "区別" や "注視" で用いられる "色" の意味は失われていきます。（もちろん，必要に応じて固定情報を "区別" や "注視" したい場面も存在します。）
<br><br>
"色" は，画面に表示される元情報の情報量を変化（追加・変更・削除）させずに，新しく別の情報を付加できます。
そのため，変化を伴わない情報の "区別" や "注視" させる目的で "色" を使用するのは有用とは言えません。<br>
`rls` では，ユーザーが頭の中で処理していた "可変" 情報のひとつを "色" で表示します。
<br><br>


## 動作原理
`rls` はユニーク文字列に色付けして表示します。<br>
判断部分はざっくり，候補を選定したあとに1文字ずつ行う感じです。

- "候補" の選定
  - 指定されたディレクトリの全ファイルを，"候補" に
  - ファイル名と拡張子により，グループを判断し，"候補" に
- 全 "候補" を対象に
  - ファイル名の 1 文字からパターンマッチング
  - マッチング**しなかった文字列**を，ユニーク文字列と判断
- 色付けして表示

ファイル名に複数のユニーク文字列候補がある場合，"文字数が少ない方"，"ファイル名の先頭に近い方" の候補が優先されます。<br>
複数のユニーク文字列が含まれていた場合でも，色付けは 1 つだけです。
<br>

プログラムは，大まかに下記のようなステップに分かれています。

1. データ取得
   - オプション処理
     - 出力対象ファイルの取捨選択
     - 出力項目の取捨選択
   - 対象のファイル情報を取得
1. データ加工
   - 出力情報の加工
   - 文字列への色付けの判断
     - ユニーク文字列（`-b`, `-e`, `-u` など）
     - 指定文字列（`-p`）
1. 出力レイアウト変更
   - 表示順（行）にソート
   - 表示する項目の順番（列）に並べ替え
   - 出力フォーマットを変更
1. 画面出力
<br><br>


## 知らないと奇妙なrlsの挙動について
`rls` を使用していると，その挙動に対して "??" と思うことがあるかもしれません。
そのような，`rls` の挙動とその判断基準を説明します。

- `rls` の `-c` オプションの設定エラーとリダイレクト<br>
  `-c` の設定エラーをリダイレクトしようとした時の挙動についてです。<br>
  例えば，`rls -ck=31` は，実行時に設定エラーのメッセージが表示されますが，`rls -ck=31 > log` と実行しても `log` ファイルに設定エラーは記録されません。<br>
  上記の場合 `rls -ck=31 -always > log` のように `-always` を追加して実行すると，`log` ファイルに設定エラーが記録されます。
  <br><br>
  `rls` のデフォルト設定では，リダイレクト出力時にエスケープシーケンスを出力しません。<br>
  リダイレクト時には，`-c` 機能自体（中のオプションの評価も）がスキップされるため，設定エラーが発生しません。
  `-ck=31` がスキップされ，`rls` が実行されることになります。<br>
  `-always` を指定することにより，`-c` のオプションの評価が行われ，エラー内容がリダイレクトされるようになります。
  <br><br>

- ユニーク文字列の判断で苦手なファイル名と，"グループ" 向けの `-e` オプション<br>
  `rls` がユニークな文字列を判断する際に，苦手なファイル名があります。<Br>
  同じディレクトリに，拡張子だけが異なるファイルが複数存在する場合，`rls` は殆どユニーク文字列と判断しません。<br>
  例えば，elisp ファイル，画像・映像・オーディオファイルなど，別フォーマットのファイル存在している場合が該当します。
  <br><br>
  `-e` オプションでは，これらの複数のファイルを同じ名前の "グループ" とし，ユニーク文字列を判断します。<br>
  その結果を "グループ" の 1 つのファイルに色付けします。<br>
  1 回の補完機能では 2 つ以上のファイル名を補完することができないため，"グループ" までがファイル名の補完対象になります。<br>
  elisp ファイルを格納しているディレクトリなどは，`-e` を指定した方が "グループ" のユニーク文字列が表示されやすくなります。<br>
  "グループ" は paint 文字色で表示されます。
  <br><br>

- `rls` のユニーク文字列の候補と，`fish` の補完対象<br>
  あれ?，ユニーク文字列はこれじゃないの? と感じた時は，それがもっと良い条件のユニーク文字列かもしれません。<br>
  実際に，`rls` が色付けしないユニーク文字列でも，`fish` が補完対象とする文字列はあります。<br>
  `-pxxx -r` などで，ユニークな文字列かどうか確認することができます。
  <br><br>
  これは，`rls` の色付け基準と `fish` のファイル補完基準が異なるために発生します。<br>
  例えば `fish` では，同じ文字が使用されている場合，ファイル名の先頭に使用されているファイルを優先して補完します。
  M<span style="color:#729fcf;">a</span>kefile と <span style="color:#729fcf;">a</span>.out の 2 つのファイルがある場合，`a` と入力して `TAB` を押した場合，`a.out` が優先して補完されます。<br>

  また，ファイル名・ディレクトリ名が同じ文字列を含む場合でも，コマンドが `cd` ならファイルは補完対象になりません。<br>
  これは，とても合理的ではありますが，`fish` に対して，あらかじめ `cd` に対する処理を設定していた結果であり，同じ `change directory` を行う別コマンドを実行しても，同じ効果は得られません。<br>
  `rls` ではファイル名からユニーク文字列を判断しているため，そもそも，`a` はユニーク文字列と判断されませんし，ユニーク文字列は使用するコマンドに依存しません。などです。
  <br><br>

- エスケープ表記と文字の置換表示について<br>
  ファイル名の一部であっても，そのままでは `fish` の補完が効かないユニーク文字列があります。<br>
  例えば，` ` (半角空白) や `(` , `-`, `&` などのコマンドランで別の意味を持つ文字です。<br>
  `rls` では，上記の文字の前にエスケープ文字 `\` を表示します。
  ファイル名を入力する際に，`\` から文字列を入力することで，補完が効くようになります。
  <br><br>
  また，`fish` のファイル名の補完機能では `-` と `_` が同等に扱われます。<br>
  キー入力は，`1キーで完結 '-'` < `同時に2キー押す '_'` < `順番に2キー押す "\-"` の順番で手間がかかると考えているため，`-` は `Shift` を押さない分 `_` より良いのですが，ユニーク文字列の先頭が `-` だった場合は `\` が必要なので，`_` の方が良いです。<br>
  上記をふまえ，`rls` では，`-` と `_` を相互に置き換えて表示します。<br>
  置換表示の文字は paint 文字色で表示されます。
  また，この置換表示は `-n` で無効化されます。
<br><br>


## おまけ
- `-b` は，ファイル名の先頭からのユニーク文字列に色付け，先頭からファイル名の補完をする shell 向け
- `-TB`, `-TE` と `-n` で，ユニーク文字列を指定文字で囲って表示，色付け不可な端末向け
- `-P` で，指定文字列情報を含むファイルのみを表示
<br><br>

- ショート形式の一覧表示をレイアウトを維持したままリダイレクト<br>
  `rls -fNk` で `ls` のリダイレクトと同等の結果
<br><br>

- `rls` の中で遅い処理<BR>
  ユニーク文字列の判断は，ファイルが多ければ使用メモリも増えますし，判断のための比較回数も増えるので，表示までの時間は長くなります。当然ユニーク文字列も長くなります。<br>
  `-s` で lstat() しなくなります。そうです。lstat() は遅い。<BR>
  `-n` で色付けをしなくなります。ユニーク文字列の判断も遅い。<br>
  - 色付けされる一覧出力なら `rls -s` が最速です。<br>
  - 色付けされない一覧出力だけなら `rls -sn` が最速です。
<br><br>


## ヘルプ
- [Version 0.3.0](./README_rls_v0.3.0.md)　のヘルプ
- [Version 0.4.0 current](./README_rls_current.md)　のヘルプ
<br><br>


## v0.3.0 からの変更内容
- add `-R` の追加，指定数字の文字列長さを paint 色で表示
- add `-f` の項目追加（`|`, `,`）
- add `-w` の追加，英語表期の場合，月，曜日などを省略せずに表示
- chg `-O` から `-S` へ変更，ソートを行わない
- add `-O` の追加，ディレクトリを非表示
- chg `main()` の initColor() のタイミング変更
- chg `colorUsage()` の処理修正
- fix `printAggregate()` の displaycount が 0 の時の処理修正
- add `freeDENT()` の追加
